#!/usr/bin/python3
'''
Simple DNS block list (DNSBL), using addresses generated by another script
'''
import os, socket, logging  # pylint: disable=multiple-imports
from binascii import hexlify

DEFAULT_DIRECTORY = os.path.join('', 'var', 'dnsbl')
DNSBL_DIRECTORY = os.getenv('DNSBL_DIRECTORY', DEFAULT_DIRECTORY)
DNSBL_PORT = int(os.getenv('DNSBL_PORT', '5353'))

logging.basicConfig(level=logging.DEBUG if __debug__ else logging.INFO)

def dnsbl(directory=DNSBL_DIRECTORY, port=DNSBL_PORT):
    '''
    Listen for queries and return valid response or NXDOMAIN if not found

    https://realpython.com/python-sockets/
    https://pythontic.com/modules/socket/udp-client-server-example
    '''
    with socket.socket(socket.AF_INET6, socket.SOCK_DGRAM) as server:
        server.bind(('::1', port))
        logging.debug('DNSBL listening...')
        while True:
            query, address = server.recvfrom(512)
            logging.debug('query: %s from %s', hexlify(query), address)

if __name__ == '__main__':
    dnsbl()
